name: Deploy backend

on:
  workflow_dispatch:
    inputs:
      backend_host:
        description: 'Backend SSH hostname'
        required: false
        default: 'pose-backend-ssh.yingliu.site'
  pull_request:
    branches:
      - main
    types:
      - closed
    paths:
      - 'backend/**'
      - '.github/workflows/deploy_backend.yml'

jobs:
  deploy:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Install cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          sudo mv cloudflared /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared

      - name: Configure SSH for Cloudflare
        run: |
          BACKEND_HOST="${{ inputs.backend_host || 'pose-backend-ssh.yingliu.site' }}"
          mkdir -p ~/.ssh
          cat << EOF >> ~/.ssh/config
          Host pose-backend
            HostName $BACKEND_HOST
            User root
            IdentitiesOnly yes
            ProxyCommand cloudflared access ssh --hostname %h
          EOF
          chmod 600 ~/.ssh/config

      - name: Test SSH via Cloudflare
        run: ssh -o StrictHostKeyChecking=accept-new pose-backend "echo 'SSH OK via Cloudflare'"

      - name: Deploy to container and restart
        run: |
          CONTAINER=pose-spatial-studio-backend

          # Sync backend files to host staging area
          rsync -az --delete \
            --exclude '.venv*' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude 'models/' \
            --exclude 'logs/' \
            --exclude '.cache/' \
            --exclude 'output/' \
            backend/ pose-backend:/tmp/backend-staging/

          # Copy into container, install deps, restart app
          ssh pose-backend << ENDSSH
            set -e

            echo "=== Copying files into container ==="
            docker cp /tmp/backend-staging/. $CONTAINER:/root/backend/

            echo "=== Installing dependencies ==="
            docker exec $CONTAINER bash -c "cd /root/backend && pip install -r requirements.txt -q"

            echo "=== Restarting app.py ==="
            docker exec $CONTAINER bash -c "pkill -f 'python.*app.py' || true"
            sleep 2
            docker exec -d $CONTAINER bash -c "cd /root/backend && mkdir -p logs && python app.py >> logs/app.log 2>&1"

            echo "=== Waiting for startup ==="
            sleep 5

            echo "=== Health check ==="
            if curl -s http://localhost:49101/health > /dev/null; then
                echo "✓ Backend is healthy!"
                curl -s http://localhost:49101/health
            else
                echo "✗ Backend health check failed!"
                docker exec $CONTAINER bash -c "tail -50 /root/backend/logs/app.log 2>/dev/null" || true
                exit 1
            fi

            rm -rf /tmp/backend-staging
          ENDSSH
