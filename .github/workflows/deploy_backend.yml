name: Deploy backend

on:
  workflow_dispatch:
    inputs:
      backend_host:
        description: 'Backend SSH hostname'
        required: false
        default: 'pose-backend-ssh.yingliu.site'
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy_backend.yml'

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_BACKEND }}
      
      - name: Debug - List keys in SSH agent
        run: ssh-add -l

      - name: Install cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          sudo mv cloudflared /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared

      - name: Configure SSH for Cloudflare
        run: |
          BACKEND_HOST="${{ inputs.backend_host || 'pose-backend-ssh.yingliu.site' }}"
          mkdir -p ~/.ssh
          cat << 'EOF' >> ~/.ssh/config
          Host pose-backend
            HostName pose-backend-ssh.yingliu.site
            User root
            ProxyCommand cloudflared access ssh --hostname %h --id ${{ secrets.CF_ACCESS_CLIENT_ID }} --secret ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          EOF
          chmod 600 ~/.ssh/config

      - name: Debug - Verify SSH config
        run: cat ~/.ssh/config

      - name: Test SSH via Cloudflare
        run: ssh -o StrictHostKeyChecking=accept-new pose-backend "echo 'SSH OK via Cloudflare'"

      - name: Deploy to container and restart
        run: |
          CONTAINER=pose-spatial-studio-backend
          TCPFORMER_DIR="/root/backend/models/tcpformer"
          TCPFORMER_FILE="TCPFormer_h36m_81.pth.tr"
          TCPFORMER_GDRIVE_ID="14D_gfCflgl67-nl0L2MJijbARizbphnP"

          # Sync backend files to host staging area
          rsync -az --delete \
            --exclude '.venv*' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude 'models/*.task' \
            --exclude 'models/*.tflite' \
            --exclude 'models/tcpformer/*.pth*' \
            --exclude 'logs/' \
            --exclude '.cache/' \
            --exclude 'output/' \
            backend/ pose-backend:/tmp/backend-staging/

          # Copy into container, install deps, restart app
          ssh pose-backend << ENDSSH
            set -e

            echo "=== Copying files into container ==="
            docker cp /tmp/backend-staging/. $CONTAINER:/root/backend/

            echo "=== Installing build tools ==="
            docker exec $CONTAINER bash -c "apt-get update -qq && apt-get install -y -qq cmake build-essential protobuf-compiler python3-dev > /dev/null 2>&1"

            echo "=== Installing dependencies ==="
            docker exec $CONTAINER bash -c "cd /root/backend && pip install --break-system-packages -r requirements.txt -q"

            echo "=== Pre-downloading TCPFormer checkpoint (if not cached) ==="
            docker exec $CONTAINER mkdir -p $TCPFORMER_DIR
            if ! docker exec $CONTAINER test -f "$TCPFORMER_DIR/$TCPFORMER_FILE"; then
              docker exec $CONTAINER pip install --break-system-packages gdown -q
              docker exec $CONTAINER gdown "$TCPFORMER_GDRIVE_ID" -O "$TCPFORMER_DIR/$TCPFORMER_FILE"
              echo "✓ TCPFormer checkpoint downloaded"
            else
              echo "✓ TCPFormer checkpoint already cached"
            fi

            echo "=== Restarting container (clears zombie processes) ==="
            docker restart $CONTAINER
            sleep 3
            docker exec -d $CONTAINER bash -c "cd /root/backend && mkdir -p logs && python app.py >> logs/app.log 2>&1"

            echo "=== Waiting for startup ==="
            sleep 5

            echo "=== GPU check ==="
            docker exec $CONTAINER python3 -c "import onnxruntime as ort; p=ort.get_available_providers(); print('Providers:', p); print('GPU:', 'YES' if 'CUDAExecutionProvider' in p else 'NO')" || true

            echo "=== Health check ==="
            if curl -s http://localhost:49101/health > /dev/null; then
                echo "✓ Backend is healthy!"
                curl -s http://localhost:49101/health
            else
                echo "✗ Backend health check failed!"
                docker exec $CONTAINER bash -c "tail -50 /root/backend/logs/app.log 2>/dev/null" || true
                exit 1
            fi

            rm -rf /tmp/backend-staging
          ENDSSH

      - name: Reset staging branch to main
        if: github.ref == 'refs/heads/main'
        run: |
          git fetch origin
          git push origin origin/main:refs/heads/staging --force
